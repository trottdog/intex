<!-- views/myJourney/event-detail-user.ejs -->

<div class="event-detail-header">
  <a href="/my-journey/events" class="back-link">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
    Back to My Events
  </a>
</div>

<div class="event-detail-layout">
  <!-- Main Content -->
  <div class="event-detail-main">
    <article class="event-detail-card">
      <!-- Event Header -->
      <div class="event-detail-hero">
        <% if (registration.event_cover_photo) { %>
          <img src="<%= registration.event_cover_photo %>" alt="<%= registration.event_name %>" />
        <% } else { %>
          <div class="event-hero-placeholder"></div>
        <% } %>
        <div class="event-hero-overlay">
          <span class="badge badge--accent"><%= registration.event_type || 'Event' %></span>
        </div>
      </div>
      
      <!-- Event Info -->
      <div class="event-detail-body">
        <h1><%= registration.event_name %></h1>
        
        <div class="event-meta-grid">
          <div class="event-meta-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <div>
              <span class="meta-label">Date</span>
              <span class="meta-value"><%= registration.event_date_start_formatted || 'TBD' %></span>
            </div>
          </div>
          
          <div class="event-meta-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <div>
              <span class="meta-label">Time</span>
              <span class="meta-value"><%= registration.event_time_start_formatted || 'TBD' %></span>
            </div>
          </div>
          
          <div class="event-meta-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <div>
              <span class="meta-label">Location</span>
              <span class="meta-value"><%= registration.event_location || 'TBD' %></span>
            </div>
          </div>
        </div>
        
        <% if (registration.event_description) { %>
          <div class="event-description">
            <h3>About This Event</h3>
            <p><%= registration.event_description %></p>
          </div>
        <% } %>
      </div>
    </article>
    
    <!-- Carpool Information -->
    <% if (carpoolAssignments.length > 0) { %>
      <section class="detail-section">
        <h2>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.5 2.8C1.4 11.3 1 12.2 1 13v3c0 .6.4 1 1 1h2"></path>
            <circle cx="7" cy="17" r="2"></circle>
            <circle cx="17" cy="17" r="2"></circle>
          </svg>
          Carpool Details
        </h2>
        
        <div class="carpool-cards">
          <% carpoolAssignments.forEach(carpool => { %>
            <div class="carpool-card">
              <div class="carpool-header">
                <span class="carpool-role <%= carpool.is_driver ? 'carpool-role--driver' : '' %>">
                  <%= carpool.is_driver ? 'Driver' : 'Passenger' %>
                </span>
              </div>
              <div class="carpool-details">
                <p><strong>Departure:</strong> <%= carpool.departure_location || 'TBD' %></p>
                <p><strong>Time:</strong> <%= carpool.departure_time_formatted || 'TBD' %></p>
                <% if (carpool.driver_name && !carpool.is_driver) { %>
                  <p><strong>Driver:</strong> <%= carpool.driver_name %></p>
                <% } %>
                <% if (carpool.notes) { %>
                  <p><strong>Notes:</strong> <%= carpool.notes %></p>
                <% } %>
              </div>
            </div>
          <% }) %>
        </div>
      </section>
    <% } %>
  </div>
  
  <!-- Sidebar -->
  <aside class="event-detail-sidebar">
    <!-- Registration Status -->
    <div class="sidebar-card">
      <h3>Your Registration</h3>
      
      <div class="status-display">
        <% if (registration.registration_status === 'Registered') { %>
          <div class="status-icon status-icon--success">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          <span class="status-text status-text--success">Registered</span>
        <% } else if (registration.registration_status === 'Attended') { %>
          <div class="status-icon status-icon--success">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          </div>
          <span class="status-text status-text--success">Attended</span>
        <% } else if (registration.registration_status === 'Cancelled') { %>
          <div class="status-icon status-icon--warning">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
          </div>
          <span class="status-text status-text--warning">Cancelled</span>
        <% } else { %>
          <div class="status-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
          </div>
          <span class="status-text"><%= registration.registration_status || 'Pending' %></span>
        <% } %>
      </div>
      
      <% if (registration.registration_check_in_date_formatted) { %>
        <p class="check-in-info">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Checked in: <%= registration.registration_check_in_date_formatted %> at <%= registration.registration_check_in_time_formatted %>
        </p>
      <% } %>
      
      <!-- Cancel Registration (if upcoming) -->
      <% if (registration.registration_status === 'Registered' && registration.is_upcoming) { %>
        <form action="/my-journey/events/<%= registration.registration_id %>/cancel" method="POST" class="mt-3">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <button type="submit" class="btn btn-outline btn-sm w-full" onclick="return confirm('Are you sure you want to cancel your registration?')">
            Cancel Registration
          </button>
        </form>
      <% } %>
    </div>
    
    <!-- Survey Section -->
    <div class="sidebar-card">
      <h3>Event Survey</h3>
      
      <% if (registration.survey_status === 'completed') { %>
        <div class="survey-completed">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <p>Thank you for completing the survey!</p>
          <% if (registration.survey_overall_score) { %>
            <div class="survey-score">
              <span class="score-value"><%= registration.survey_overall_score %></span>
              <span class="score-label">/ 10</span>
            </div>
          <% } %>
        </div>
      <% } else if (registration.can_complete_survey) { %>
        <p class="text-muted mb-2">Help us improve by sharing your feedback about this event.</p>
        <a href="/my-journey/surveys/<%= registration.registration_id %>" class="btn btn-primary w-full">
          Take Survey
        </a>
      <% } else { %>
        <div class="survey-unavailable">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <p>Survey not available yet. It will be unlocked after the event.</p>
        </div>
      <% } %>
    </div>
    
    <!-- Quick Links -->
    <div class="sidebar-card">
      <h3>Quick Links</h3>
      <div class="quick-links">
        <a href="/events/<%= registration.event_details_id %>" class="quick-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          View Public Event Page
        </a>
        <a href="/my-journey/events" class="quick-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          All My Events
        </a>
      </div>
    </div>
  </aside>
</div>

<style>
  /* Back Link */
  .event-detail-header {
    margin-bottom: 1.5rem;
  }
  
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    font-weight: 500;
    transition: color var(--transition-fast);
  }
  
  .back-link:hover {
    color: var(--color-primary-dark);
  }
  
  /* Layout */
  .event-detail-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 1.5rem;
    align-items: start;
  }
  
  /* Main Content */
  .event-detail-card {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-soft);
    border: 1px solid var(--color-border-subtle);
  }
  
  .event-detail-hero {
    position: relative;
    height: 250px;
    background: linear-gradient(135deg, var(--color-primary-soft) 0%, var(--color-dusty-blue) 100%);
  }
  
  .event-detail-hero img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .event-hero-placeholder {
    width: 100%;
    height: 100%;
  }
  
  .event-hero-overlay {
    position: absolute;
    top: 1rem;
    left: 1rem;
  }
  
  .event-detail-body {
    padding: 2rem;
  }
  
  .event-detail-body h1 {
    font-size: var(--text-2xl);
    margin: 0 0 1.5rem;
  }
  
  .event-meta-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .event-meta-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .event-meta-item svg {
    width: 20px;
    height: 20px;
    color: var(--color-primary-dark);
    flex-shrink: 0;
    margin-top: 2px;
  }
  
  .meta-label {
    display: block;
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .meta-value {
    display: block;
    font-weight: 500;
  }
  
  .event-description {
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border-subtle);
  }
  
  .event-description h3 {
    font-size: var(--text-md);
    margin: 0 0 0.75rem;
  }
  
  .event-description p {
    color: var(--color-text-muted);
    margin: 0;
    line-height: 1.7;
  }
  
  /* Detail Section */
  .detail-section {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-top: 1.5rem;
    box-shadow: var(--shadow-soft);
    border: 1px solid var(--color-border-subtle);
  }
  
  .detail-section h2 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: var(--text-lg);
    margin: 0 0 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border-subtle);
  }
  
  .detail-section h2 svg {
    color: var(--color-text-muted);
  }
  
  /* Carpool Cards */
  .carpool-cards {
    display: grid;
    gap: 1rem;
  }
  
  .carpool-card {
    background: var(--color-bg);
    border-radius: var(--radius-md);
    padding: 1rem;
  }
  
  .carpool-header {
    margin-bottom: 0.75rem;
  }
  
  .carpool-role {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: var(--color-surface);
    border-radius: var(--radius-pill);
    font-size: var(--text-xs);
    font-weight: 600;
  }
  
  .carpool-role--driver {
    background: var(--color-primary-soft);
    color: var(--color-primary-dark);
  }
  
  .carpool-details p {
    font-size: var(--text-sm);
    margin: 0 0 0.35rem;
  }
  
  /* Sidebar */
  .event-detail-sidebar {
    position: sticky;
    top: calc(var(--header-height) + 1rem);
  }
  
  .sidebar-card {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    margin-bottom: 1rem;
    box-shadow: var(--shadow-soft);
    border: 1px solid var(--color-border-subtle);
  }
  
  .sidebar-card h3 {
    font-size: var(--text-md);
    margin: 0 0 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border-subtle);
  }
  
  /* Status Display */
  .status-display {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .status-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--color-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted);
  }
  
  .status-icon svg {
    width: 20px;
    height: 20px;
  }
  
  .status-icon--success {
    background: var(--color-success-soft);
    color: var(--color-accent-dark);
  }
  
  .status-icon--warning {
    background: rgba(244, 176, 146, 0.2);
    color: #c97a4a;
  }
  
  .status-text {
    font-weight: 600;
  }
  
  .status-text--success {
    color: var(--color-accent-dark);
  }
  
  .status-text--warning {
    color: #c97a4a;
  }
  
  .check-in-info {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: var(--text-sm);
    color: var(--color-accent-dark);
    margin: 1rem 0 0;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border-subtle);
  }
  
  /* Survey States */
  .survey-completed {
    text-align: center;
    padding: 1rem;
    background: var(--color-success-soft);
    border-radius: var(--radius-md);
  }
  
  .survey-completed p {
    margin: 0.75rem 0 0;
    font-size: var(--text-sm);
    color: var(--color-accent-dark);
  }
  
  .survey-score {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 0.15rem;
    margin-top: 0.5rem;
  }
  
  .score-value {
    font-family: var(--font-heading);
    font-size: var(--text-2xl);
    color: var(--color-accent-dark);
  }
  
  .score-label {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }
  
  .survey-unavailable {
    text-align: center;
    padding: 1rem;
    background: var(--color-bg);
    border-radius: var(--radius-md);
    color: var(--color-text-muted);
  }
  
  .survey-unavailable p {
    margin: 0.75rem 0 0;
    font-size: var(--text-sm);
  }
  
  /* Quick Links */
  .quick-links {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .quick-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: var(--color-bg);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    color: var(--color-text);
    transition: all var(--transition-fast);
  }
  
  .quick-link:hover {
    background: var(--color-primary-soft);
    color: var(--color-primary-dark);
  }
  
  /* Responsive */
  @media (max-width: 900px) {
    .event-detail-layout {
      grid-template-columns: 1fr;
    }
    
    .event-detail-sidebar {
      position: static;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }
    
    .sidebar-card {
      margin-bottom: 0;
    }
  }
</style>
